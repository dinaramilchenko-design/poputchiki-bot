import json
import os
from telegram import Update
from telegram.ext import Application, CommandHandler, ContextTypes

# –í–ê–® –¢–û–ö–ï–ù (–≤—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞!)
BOT_TOKEN = "123456789:ABCdefGhIJKlmnoPqrStUvwxYz123456789"  # ‚Üê –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ô!

# –§–∞–π–ª –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π
DATA_FILE = "users.json"

# –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞
def load_data():
    if os.path.exists(DATA_FILE):
        with open(DATA_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    return {}

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª
def save_data(data):
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

# –ö–æ–º–∞–Ω–¥–∞ /elektrichka 18:15
async def set_time(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    username = update.effective_user.username
    if not username:
        await update.message.reply_text("‚ùó –£ –≤–∞—Å –Ω–µ—Ç username –≤ Telegram. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–æ—Ñ–∏–ª—è.")
        return

    if not context.args:
        await update.message.reply_text("üìå –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /elektrichka 18:15")
        return

    time = context.args[0]
    data = load_data()

    if time not in 
        data[time] = []

    if username not in data[time]:
        data[time].append(username)
        save_data(data)
        await update.message.reply_text(f"‚úÖ –í—ã –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ —ç–ª–µ–∫—Ç—Ä–∏—á–∫—É –≤ {time}!")
    else:
        await update.message.reply_text(f"–í—ã —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ {time}!")

# –ö–æ–º–∞–Ω–¥–∞ /list 18:15 ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫
async def show_list(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not context.args:
        await update.message.reply_text("üìå –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /list 18:15")
        return

    time = context.args[0]
    data = load_data()

    if time not in data or len(data[time]) == 0:
        await update.message.reply_text(f"–ù–∞ —ç–ª–µ–∫—Ç—Ä–∏—á–∫—É –≤ {time} –ø–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –∑–∞–ø–∏—Å–∞–ª—Å—è.")
        return

    users = ", ".join([f"@{u}" for u in data[time]])
    await update.message.reply_text(f"üë• –ù–∞ —ç–ª–µ–∫—Ç—Ä–∏—á–∫—É –≤ {time} –∏–¥—É—Ç:\n{users}\n\nüìç –í—Å—Ç—Ä–µ—á–∞–µ–º—Å—è —É –≤—Ö–æ–¥–∞ –∑–∞ 5 –º–∏–Ω—É—Ç –¥–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è!")

# –ö–æ–º–∞–Ω–¥–∞ /cancel 18:15 ‚Äî –æ—Ç–ø–∏—Å–∞—Ç—å—Å—è
async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not context.args:
        await update.message.reply_text("üìå –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /cancel 18:15")
        return

    time = context.args[0]
    username = update.effective_user.username
    data = load_data()

    if time in data and username in data[time]:
        data[time].remove(username)
        save_data(data)
        await update.message.reply_text(f"‚ùå –í—ã –æ—Ç–ø–∏—Å–∞–ª–∏—Å—å –æ—Ç —ç–ª–µ–∫—Ç—Ä–∏—á–∫–∏ –≤ {time}.")
    else:
        await update.message.reply_text(f"–í—ã –Ω–µ –±—ã–ª–∏ –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ {time}.")

# –ö–æ–º–∞–Ω–¥–∞ /help
async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "üìå –ë–æ—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–ø—É—Ç—á–∏–∫–æ–≤ –Ω–∞ —ç–ª–µ–∫—Ç—Ä–∏—á–∫—É\n\n"
        "/elektrichka 18:15 ‚Äî –∑–∞–ø–∏—Å–∞—Ç—å—Å—è\n"
        "/list 18:15 ‚Äî –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å, –∫—Ç–æ –∏–¥—ë—Ç\n"
        "/cancel 18:15 ‚Äî –æ—Ç–ø–∏—Å–∞—Ç—å—Å—è\n"
        "/help ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ\n\n"
        "–ë–æ—Ç –Ω–µ —Ö—Ä–∞–Ω–∏—Ç –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ ‚Äî —Ç–æ–ª—å–∫–æ –Ω–∏–∫–Ω–µ–π–º—ã –≤ Telegram. –ë–µ–∑–æ–ø–∞—Å–Ω–æ!"
    )

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
def main():
    application = Application.builder().token(BOT_TOKEN).build()

    application.add_handler(CommandHandler("elektrichka", set_time))
    application.add_handler(CommandHandler("list", show_list))
    application.add_handler(CommandHandler("cancel", cancel))
    application.add_handler(CommandHandler("help", help_command))

    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω! –û–∂–∏–¥–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è...")
    application.run_polling()

if __name__ == "__main__":
    main()